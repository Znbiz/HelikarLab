<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="ru">
<head>
    <title>Drawing Text with Signed Distance Fields</title>
    <script src="index_files/glutil.js"></script>
    <script src="index_files/glmatrix.js"></script>
    <script src="atlas_sdf.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
</head>
<body>

    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <label>Size <input type="range" style="width:400px" value="26" step="0.01" min="6" max="128.0" id="scale"></label><br>
                <label>Translate X <input type="range" style="width:400px" value="0" step="0.01" min="0.0" max="10.0" id="translateX"></label><br>
                <label>Buffer <input type="range" style="width:400px" value="0.2" step="0.01" min="0.1" max="0.7" id="buffer"></label><br>
                <label>Angle <input type="range" style="width:400px" value="0" step="0.01" min="-3.141592" max="3.141592" id="angle"></label><br>
                <label>Gamma <input type="range" style="width:400px" value="1" step="0.01" min="0" max="4" id="gamma"></label><br>
                <label>Texture <input type="checkbox" id="debug"></label><br>
            </div>
            <div class="col-md-6">
                <p>Enter the starting index ASCII: <input type="number" id="chars_start" value=90></p>
                <p>Enter the ending index ASCII: <input type="number" id="chars_end" value=127></p>
                <p>Enter the name of the font: <input type="text" id="font_family" value="Arial"></p>
                <p>Enter the size of the font: <input type="number" id="font_size" value=50></p>
                <button onclick="Start();">Start</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <canvas id="webgl" width="512" height="512" style=""></canvas>
            </div>
            <div class="col-md-6" id="atlas_canvas">
                <canvas id="atlas" width="512" height="512" style=""></canvas>
                <button id="save" onclick="save();">Save Atlas in full size</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6" id="text-metrics">
                <p>Data for work with the atlas:<br/>
                "family" - font,<br/>
                "style" - style font,<br/>
                "size" - size font,<br/>
                "chars" - characters in sdf format.</p>

                <p>Each char has an array containing 7 the values:<br/>
                "char"[0] -  width the square in which is located the symbol,<br/>
                "char"[1] -  height the square in which is located the symbol,<br/>
                "char"[2] -  left indent before the character inside the square,<br/>
                "char"[3] -  right indent after the character inside the square,<br/>
                "char"[4] -  character width squared,<br/>
                "char"[5] -  position at X a square on the atlas in which is located the symbol,<br/>
                "char"[6] -  position at Y a square on the atlas in which is located the symbol.</p>
            </div>
            <div class="col-md-6" id="metrics">
                
            </div>
        </div>
    </div>
    <script id="sdf-vertex" type="x-shader/x-vertex">
        attribute vec2 a_pos;
        attribute vec2 a_texcoord;

        uniform mat4 u_matrix;
        uniform vec2 u_texsize;

        varying vec2 v_texcoord;

        void main() {
            gl_Position = u_matrix * vec4(a_pos.xy, 0, 1);
            v_texcoord = a_texcoord / u_texsize;
        }
    </script>

    <script id="sdf-fragment" type="x-shader/x-fragment">
        precision mediump float;

        uniform sampler2D u_texture;
        uniform vec4 u_color;
        uniform float u_buffer;
        uniform float u_gamma;
        uniform float u_debug;

        varying vec2 v_texcoord;

        void main() {
            float dist = texture2D(u_texture, v_texcoord).r;
            if (u_debug > 0.0) {
                gl_FragColor = vec4(dist, dist, dist, 1);
            } else {
                float alpha = smoothstep(u_buffer - u_gamma, u_buffer + u_gamma, dist);
                gl_FragColor = vec4(u_color.rgb, alpha * u_color.a);
            }
        }
    </script>

    <script type="text/javascript">
        
        /*
         option for create atlas_sdf
         */
        var options = {
            size: 50,
            font_family: "Arial",
            start: 90,
            end: 127
        }

        var result =  generate_SDF_atlas_font(options);
        Main(result);

        function Start() {
            options.size = parseInt(document.getElementById('font_size').value);
            options.font_family = document.getElementById('font_family').value;
            options.start = parseInt(document.getElementById('chars_start').value);
            options.end = parseInt(document.getElementById('chars_end').value);
            
            result =  generate_SDF_atlas_font(options);
            Main(result);
        }

        function save(){
            window.open(result.img,"atlas");
        }

        /**
         * Function atlas drawing and display more information about it
         * @param  {object} result_generate_SDF_atlas_font - result of work function generate_SDF_atlas_font
         */
        function Main(result_generate_SDF_atlas_font) {
            /**
             * Pictures download function
             * @param  {string}   url  - link or pictures
             * @param  {Function} done [description]
             */
            function loadCanvas(url, done) {
                var img = new Image();
                img.onload = function() { done(img); };
                
                img.src = url;
            }

            var scale = 64;
            var metrics = result_generate_SDF_atlas_font.metrics;
            var atlas_canvas = document.getElementById('atlas');
            loadCanvas(result_generate_SDF_atlas_font.img, function(atlas){
                atlas_canvas.width = atlas.width;
                atlas_canvas.height = atlas.height;
                var atlas_ctx = atlas_canvas.getContext('2d');
                atlas_ctx.drawImage(atlas, 0, 0);

                 /*
                 Mini atlas
                 */
                atlas_canvas.width = 512;
                atlas_canvas.height = 512;
                atlas_ctx.scale(512 / atlas.width, 512 / atlas.height);
                atlas_ctx.drawImage(atlas, 0, 0);
            });

            document.getElementById('metrics').innerHTML = JSON.stringify(metrics);

            /*
             All that is below is taken from the example mapbox 
             https://www.mapbox.com/blog/text-signed-distance-fields/
             */
            function drawGlyph(chr, pen, size, vertexElements, textureElements) {
                var metric = metrics.chars[chr];
                if (!metric) return;

                var scale = size / metrics.size;

                var factor = 1;

                var width = metric[0];
                var height = metric[1];
                var padding_left = metric[2];
                var padding_right = metric[3];
                var horiAdvance = metric[4];
                var posX = metric[5];
                var posY = metric[6];

                if (width > 0 && height > 0) {
                    pen.x = pen.x - padding_left * scale;
                    // Add a quad (= two triangles) per glyph.
                    vertexElements.push(
                        pen.x, pen.y,
                        pen.x + width * scale, pen.y,
                        pen.x, pen.y + height * scale,

                        pen.x + width * scale, pen.y,
                        pen.x, pen.y + height * scale,
                        pen.x + width * scale, pen.y + height * scale
                    );

                    textureElements.push(
                        posX, posY,
                        posX + width, posY,
                        posX, posY + height,

                        posX + width, posY,
                        posX, posY + height,
                        posX + width, posY + height
                    ); 
                }
               
                pen.x = pen.x + padding_right * scale;
            }


            function measureText(text, size) {
                var dimensions = {
                    advance: 0
                }

                var scale = size / metrics.size;
                for (var i = 0; i < text.length; i++) {
                    var horiAdvance = 0;
                    if(metrics.chars[text[i]]){
                        var horiAdvance = metrics.chars[text[i]][4];
                    }
                    dimensions.advance += horiAdvance * scale;
                }

                return dimensions;
            }



            // Initialize GL Canvas
            var canvas = document.getElementById('webgl');


            var pixelRatio = 'devicePixelRatio' in window ? devicePixelRatio : 1;

            if (devicePixelRatio > 1 && !canvas.scaled) {
                pixelRatio = devicePixelRatio;
                canvas.style.width = canvas.width + 'px';
                canvas.width = canvas.width * pixelRatio;
                canvas.style.height = canvas.height + 'px';
                canvas.height = canvas.height * pixelRatio;
                canvas.scaled = true;
            }

            var gl = canvas.getContext("experimental-webgl", { antialias: false });
            if (!gl) {
                alert('Failed to initialize WebGL');
            }

            gl.getExtension("OES_standard_derivatives");

            // Initialize shaders
            var shader = gl.initializeShader('sdf',
                ['a_pos', 'a_texcoord'],
                ['u_matrix', 'u_texture', 'u_texsize', 'u_color', 'u_buffer', 'u_gamma', 'u_debug']);

            gl.useProgram(shader.program);
            gl.enableVertexAttribArray(shader.a_pos);
            gl.enableVertexAttribArray(shader.a_texcoord);




            var pMatrix = mat4.create();

            mat4.ortho(pMatrix, 0, gl.canvas.width, gl.canvas.height, 0, 0, -1);


            gl.blendFuncSeparate(
                gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA,
                gl.ONE, gl.ONE);

            gl.enable(gl.BLEND);

            var texture = gl.createTexture();


            var vertexBuffer = gl.createBuffer();
            var textureBuffer = gl.createBuffer();



            var str = "Znbiz";

            function createText(size) {
                var vertexElements = [];
                var textureElements = [];

                var dimensions = measureText(str, size);

                var pen = { x: canvas.width / 2 - dimensions.advance / 2, y: canvas.height / 2 };
                for (var i = 0; i < str.length; i++) {
                    var chr = str[i];
                    drawGlyph(chr, pen, size, vertexElements, textureElements);
                }

                gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexElements), gl.STATIC_DRAW);
                vertexBuffer.numItems = vertexElements.length / 2;

                gl.bindBuffer(gl.ARRAY_BUFFER, textureBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(textureElements), gl.STATIC_DRAW);
                textureBuffer.numItems = textureElements.length / 2;
            }

             
            // loadCanvas("OpenSans-Regular.png", function(atlas) {
            loadCanvas(result_generate_SDF_atlas_font.img, function(atlas) {
                gl.bindTexture(gl.TEXTURE_2D, texture);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.LUMINANCE, gl.LUMINANCE, gl.UNSIGNED_BYTE, atlas);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

                gl.uniform2f(shader.u_texsize, atlas.width, atlas.height)

                draw();
            });


            function draw() {
                gl.clearColor(0.9, 0.9, 0.9, 1);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);


                var scale = +document.getElementById('scale').value;
                var buffer = +document.getElementById('buffer').value;
                var angle = +document.getElementById('angle').value;
                var translateX = +document.getElementById('translateX').value;
                var gamma = +document.getElementById('gamma').value;
                var debug = +document.getElementById('debug').checked;


                createText(scale);

                var mvMatrix = mat4.create();
                mat4.identity(mvMatrix);
                mat4.translate(mvMatrix, mvMatrix, [ canvas.width / 2, canvas.height / 2, 0 ]);
                mat4.rotateZ(mvMatrix, mvMatrix, angle);
                mat4.translate(mvMatrix, mvMatrix, [ -canvas.width / 2, -canvas.height / 2, 0 ]);
                mat4.translate(mvMatrix, mvMatrix, [ translateX, 0, 0 ]);

                var mvpMatrix = mat4.create();
                mat4.multiply(mvpMatrix, pMatrix, mvMatrix);
                gl.uniformMatrix4fv(shader.u_matrix, false, mvpMatrix);

                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, texture);
                gl.uniform1i(shader.u_texture, 0);

                gl.uniform1f(shader.u_scale, 1.0);
                gl.uniform1f(shader.u_debug, debug ? 1 : 0);

                gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
                gl.vertexAttribPointer(shader.a_pos, 2, gl.FLOAT, false, 0, 0);


                gl.bindBuffer(gl.ARRAY_BUFFER, textureBuffer);
                gl.vertexAttribPointer(shader.a_texcoord, 2, gl.FLOAT, false, 0, 0);

                gl.uniform4fv(shader.u_color, [ 1, 1, 1, 1 ]);
                gl.uniform1f(shader.u_buffer, buffer);
                gl.drawArrays(gl.TRIANGLES, 0, vertexBuffer.numItems);

                gl.uniform4fv(shader.u_color, [ 0, 0, 0, 1 ]);
                gl.uniform1f(shader.u_buffer, 192 / 256);
                gl.uniform1f(shader.u_gamma, gamma * 1.4142 / scale);
                gl.drawArrays(gl.TRIANGLES, 0, vertexBuffer.numItems);
            }


            document.getElementById('scale').oninput = draw;
            document.getElementById('buffer').oninput = draw;
            document.getElementById('angle').oninput = draw;
            document.getElementById('translateX').oninput = draw;
            document.getElementById('gamma').oninput = draw;
            document.getElementById('debug').oninput = draw;
        }

        

        

       

        

        

    </script>
</body>
</html>